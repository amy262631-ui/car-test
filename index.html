<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>何鑫/薪昌 - 雲端管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem; width: 100%; outline: none; transition: all 0.2s; background: white; font-size: 0.875rem; }
        input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .section-title { color: #1e40af; font-weight: 800; border-left: 5px solid #2563eb; padding-left: 0.75rem; margin-bottom: 1.25rem; font-size: 1rem; display: flex; align-items: center; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media print { .no-print { display: none !important; } #printArea { display: block !important; } body { background: white; padding: 0; } }
        #printArea { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="font-bold text-blue-800 tracking-widest">雲端資料同步中...</p>
    </div>

    <div class="max-w-7xl mx-auto no-print">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-xl border border-gray-100 gap-4">
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-4 rounded-2xl text-white shadow-lg shadow-blue-200">
                    <i class="fas fa-cloud text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight">何鑫實業 / 薪昌</h1>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Multi-User Management System</p>
                </div>
            </div>
            <div class="flex space-x-3 w-full md:w-auto">
                <button onclick="syncData()" class="flex-1 bg-white border border-slate-200 text-slate-600 px-5 py-3 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-2"></i> 同步
                </button>
                <button onclick="exportToExcel()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-xl font-bold shadow-md transition-all flex items-center justify-center">
                    <i class="fas fa-file-excel mr-2"></i> 導出月報表
                </button>
                <button onclick="openModal('add')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> 新增派車
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center transition-transform hover:scale-[1.01]">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase mb-1 tracking-widest">今日派車件數</p>
                    <h2 id="stat-today" class="text-5xl font-black text-slate-800 tracking-tighter">0</h2>
                </div>
                <div class="text-blue-500 bg-blue-50 p-5 rounded-2xl shadow-inner"><i class="far fa-calendar-check text-3xl"></i></div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center transition-transform hover:scale-[1.01]">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase mb-1 tracking-widest">本月累計派車</p>
                    <h2 id="stat-month" class="text-5xl font-black text-slate-800 tracking-tighter">0</h2>
                </div>
                <div class="text-indigo-500 bg-indigo-50 p-5 rounded-2xl shadow-inner"><i class="fas fa-layer-group text-3xl"></i></div>
            </div>
        </div>

        <div class="mb-6 relative">
            <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-300"></i>
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="快速搜尋客戶、下貨地點、廠商或申請人..." class="pl-14 py-5 rounded-3xl border-none shadow-lg text-slate-600 placeholder:text-slate-300 w-full">
        </div>

        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] border-b border-slate-100">
                        <tr>
                            <th class="p-6">公司 / 時間</th>
                            <th class="p-6">客戶資訊</th>
                            <th class="p-6">需求車輛</th>
                            <th class="p-6">行程路線</th>
                            <th class="p-6 text-right">廠商 / 報價</th>
                            <th class="p-6 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-slate-50">
                        <tr><td colspan="6" class="p-10 text-center text-slate-300">資料讀取中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="formModal" class="modal flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-[2.5rem] w-full max-w-6xl max-h-[94vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 id="modalTitle" class="text-2xl font-black text-slate-800">新增派車申請</h3>
                    <p class="text-xs text-slate-400 mt-1 font-bold">資料將同步儲存至雲端 Google Sheets</p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 flex items-center justify-center rounded-2xl hover:bg-white hover:shadow-md text-slate-400 transition-all font-bold text-xl">&times;</button>
            </div>
            
            <form id="dispatchForm" class="flex-1 overflow-y-auto p-8 md:p-12 space-y-12 custom-scrollbar">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                    <div>
                        <div class="section-title"><i class="fas fa-building mr-2"></i> 所屬公司</div>
                        <div class="flex gap-4 mt-2">
                            <label class="flex-1 flex items-center justify-center p-4 rounded-2xl border-2 cursor-pointer transition-all has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 has-[:checked]:text-blue-700">
                                <input type="radio" name="company" value="何鑫實業" checked class="hidden">
                                <span class="font-bold">何鑫實業</span>
                            </label>
                            <label class="flex-1 flex items-center justify-center p-4 rounded-2xl border-2 cursor-pointer transition-all has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 has-[:checked]:text-orange-700">
                                <input type="radio" name="company" value="薪昌" class="hidden">
                                <span class="font-bold">薪昌</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <div class="section-title"><i class="far fa-clock mr-2"></i> 派車時間</div>
                        <div class="flex gap-2">
                            <input type="date" id="f-date" required>
                            <input type="time" id="f-time" required>
                        </div>
                    </div>
                    <div>
                        <div class="section-title"><i class="far fa-user mr-2"></i> 申請人</div>
                        <input type="text" id="f-applicant" placeholder="請輸入姓名" required>
                    </div>
                </div>

                <div>
                    <div class="section-title"><i class="fas fa-id-card-alt mr-2"></i> 專案資訊 (客戶聯動)</div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="relative">
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">客戶簡稱 *</label>
                            <input type="text" id="f-client" list="clientOptions" placeholder="搜尋或手動輸入..." oninput="handleClientLookup(this.value)">
                            <datalist id="clientOptions"></datalist>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">現場聯絡人</label>
                            <input type="text" id="f-contact">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">聯絡電話</label>
                            <input type="tel" id="f-phone">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">預定下貨地址</label>
                            <input type="text" id="f-address">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div>
                        <div class="section-title"><i class="fas fa-truck mr-2"></i> 車輛規格</div>
                        <input type="text" id="f-vspec" list="vOptions" placeholder="選擇或手動輸入車型規格...">
                        <datalist id="vOptions"></datalist>
                    </div>
                    <div>
                        <div class="section-title"><i class="fas fa-plus-circle mr-2"></i> 特殊需求 (複選)</div>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="需車尾門" class="mr-3 w-4 h-4 rounded"> 需車尾門
                            </label>
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="需油壓板車" class="mr-3 w-4 h-4 rounded"> 需油壓板車
                            </label>
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="兩地載貨" class="mr-3 w-4 h-4 rounded"> 兩地載貨
                            </label>
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="需堆高機" class="mr-3 w-4 h-4 rounded"> 需堆高機
                            </label>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="section-title"><i class="fas fa-boxes mr-2"></i> 出貨清單明細 (尺寸單位: m / 重量單位: kg)</div>
                    <div class="overflow-x-auto border rounded-2xl shadow-inner bg-slate-50/20">
                        <table class="w-full text-xs">
                            <thead class="bg-slate-100 text-slate-500 font-black border-b">
                                <tr>
                                    <th class="p-4 text-left">品項名稱</th>
                                    <th class="p-4 text-center w-20">數量</th>
                                    <th class="p-4 text-center w-20">單位</th>
                                    <th class="p-4 text-center w-20">長(m)</th>
                                    <th class="p-4 text-center w-20">寬(m)</th>
                                    <th class="p-4 text-center w-20">高(m)</th>
                                    <th class="p-4 text-center w-24">重量(kg)</th>
                                    <th class="p-4 text-center w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="cargoList"></tbody>
                        </table>
                    </div>
                    <button type="button" onclick="addCargoRow()" class="mt-4 text-blue-600 font-black text-xs flex items-center hover:scale-105 transition-transform origin-left">
                        <i class="fas fa-plus-circle mr-2 text-lg"></i> 新增品項行
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 border-t pt-10">
                    <div class="space-y-4">
                        <div class="section-title"><i class="fas fa-map-marked-alt mr-2"></i> 行程與備註</div>
                        <div class="flex gap-2">
                            <input type="text" id="f-from" placeholder="上貨地點 (起點)">
                            <input type="text" id="f-to" placeholder="下貨地點 (目的地)">
                        </div>
                        <textarea id="f-notes" rows="3" placeholder="備註事項 (如：指定駕駛、緊急聯絡、場地限制等)"></textarea>
                    </div>
                    <div class="space-y-4">
                        <div class="section-title"><i class="fas fa-hand-holding-usd mr-2"></i> 廠商報價</div>
                        <input type="text" id="f-vendor" list="vendorOptions" placeholder="選擇或手動輸入廠商名稱">
                        <datalist id="vendorOptions"></datalist>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-300">NT$</span>
                            <input type="number" id="f-price" placeholder="0" class="pl-14">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 border-t pt-10 bg-white sticky bottom-0 z-10">
                    <button type="button" onclick="closeModal()" class="px-10 py-4 text-slate-400 font-bold hover:text-slate-600">取消</button>
                    <button type="submit" class="px-16 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl shadow-blue-100 hover:bg-blue-700 hover:-translate-y-1 transition-all flex items-center">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> 儲存並同步雲端
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="printArea" class="p-16 text-slate-900 bg-white">
        <h1 id="p-company-title" class="text-4xl font-black text-center border-b-[6px] border-slate-900 pb-6 mb-12 tracking-[0.3em]"></h1>
        <div class="grid grid-cols-2 gap-y-6 mb-12 text-lg">
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">派車時間：</span> <span id="p-datetime" class="font-bold"></span></div>
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">申請人員：</span> <span id="p-applicant" class="font-bold"></span></div>
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">客戶簡稱：</span> <span id="p-client" class="font-bold"></span></div>
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">聯絡電話：</span> <span id="p-phone" class="font-bold"></span></div>
            <div class="col-span-2 border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">下貨地址：</span> <span id="p-address" class="font-bold text-xl"></span></div>
            <div class="col-span-2 border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">行程路線：</span> <span id="p-route" class="font-bold"></span></div>
        </div>
        <table class="w-full border-collapse border-[3px] border-slate-900 mb-12 text-lg">
            <thead>
                <tr class="bg-slate-50">
                    <th class="border-[3px] border-slate-900 p-4 text-left font-black">貨物品項名稱</th>
                    <th class="border-[3px] border-slate-900 p-4 text-center w-40 font-black">數量單位</th>
                    <th class="border-[3px] border-slate-900 p-4 text-center w-72 font-black">規格尺寸 (L/W/H/W)</th>
                </tr>
            </thead>
            <tbody id="p-cargo-list"></tbody>
        </table>
        <div class="space-y-4 mb-24">
            <div class="flex"><span class="font-black w-32 border-l-4 border-slate-900 pl-3">特殊需求：</span><span id="p-needs" class="font-bold text-blue-700 underline"></span></div>
            <div class="flex"><span class="font-black w-32 border-l-4 border-slate-900 pl-3">備註事項：</span><span id="p-notes" class="font-medium text-slate-500"></span></div>
        </div>
        <div class="grid grid-cols-3 gap-16 text-center">
            <div><div class="border-b-2 border-slate-900 h-24"></div><p class="mt-4 font-black text-lg">核准主管</p></div>
            <div><div class="border-b-2 border-slate-900 h-24"></div><p class="mt-4 font-black text-lg">現場收貨簽章</p></div>
            <div><div class="border-b-2 border-slate-900 h-24"></div><p class="mt-4 font-black text-lg">駕駛人員簽章</p></div>
        </div>
    </div>

    <script>
        /**
         * 雲端存取配置 - 請務必替換為新的部署網址
         */
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxuPNtja0KUhPrYlUnRnu3uw-Di7xiucp4ePI2GsTB8ytQuqi1pc1fHxCOmak_ckarpxA/exec";

        let masterData = { clients: [], vendors: [], vehicles: [] };
        let dispatches = [];

        // 頁面初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (GAS_URL.includes("請在此貼上")) {
                alert("請先將 GAS 部署網址貼入程式碼中的 GAS_URL 變數！");
            } else {
                syncData();
            }
        });

        // 從 GAS 同步資料 (GET)
        async function syncData() {
            toggleLoading(true);
            try {
                const response = await fetch(GAS_URL);
                if (!response.ok) throw new Error("網路請求失敗");
                
                const res = await response.json();
                if (res.status === "error") throw new Error(res.message);

                // 處理下拉選單資料
                masterData.clients = res.clients || [];
                masterData.vendors = (res.vendors || []).map(v => v.廠商名稱).filter(v => v);
                masterData.vehicles = (res.vehicles || []).map(v => v.車輛規格).filter(v => v);
                
                // 處理派車紀錄資料
                dispatches = (res.records || []).map(r => {
                    let parsedNeeds = [];
                    let parsedCargo = [];
                    try { parsedNeeds = typeof r.needs === 'string' ? JSON.parse(r.needs) : (r.needs || []); } catch(e){}
                    try { parsedCargo = typeof r.cargo === 'string' ? JSON.parse(r.cargo) : (r.cargo || []); } catch(e){}
                    
                    return { ...r, needs: parsedNeeds, cargo: parsedCargo };
                }).sort((a,b) => b.id - a.id);

                updateDatalists();
                renderTable();
            } catch (err) {
                console.error("同步失敗:", err);
                alert("無法同步資料: " + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // 儲存至 GAS (POST)
        async function saveToCloud(data, action = "save") {
            toggleLoading(true);
            try {
                // 使用標準 POST 請求
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // 由於 GAS 的跳轉限制，維持 no-cors 是較簡單的作法
                    body: JSON.stringify({ action, data })
                });
                
                // 因為 no-cors 無法獲取回應，我們直接等待後重新讀取
                setTimeout(async () => {
                    await syncData();
                    closeModal();
                }, 1000);
                
                return true;
            } catch (err) {
                console.error("儲存失敗:", err);
                alert("雲端儲存失敗，請檢查網路連線。");
                toggleLoading(false);
                return false;
            }
        }

        // 更新下拉選單清單
        function updateDatalists() {
            document.getElementById('clientOptions').innerHTML = masterData.clients.map(c => `<option value="${c.客戶簡稱}">`).join('');
            document.getElementById('vOptions').innerHTML = masterData.vehicles.map(v => `<option value="${v}">`).join('');
            document.getElementById('vendorOptions').innerHTML = masterData.vendors.map(v => `<option value="${v}">`).join('');
        }

        // 客戶聯動邏輯
        function handleClientLookup(val) {
            const client = masterData.clients.find(c => c.客戶簡稱 === val);
            if (client) {
                document.getElementById('f-contact').value = client.聯絡人 || '';
                document.getElementById('f-phone').value = client.電話 || '';
                document.getElementById('f-address').value = client.下貨地址 || '';
                document.getElementById('f-to').value = client.下貨地址 || '';
            }
        }

        // 渲染主列表
        function renderTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let todayCount = 0;
            let monthCount = 0;

            dispatches.forEach(d => {
                const dDate = new Date(d.date);
                if(d.date === today) todayCount++;
                if(dDate.getMonth() === currentMonth && dDate.getFullYear() === currentYear) monthCount++;

                const row = `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="p-6">
                        <div class="font-black text-xs ${d.company === '何鑫實業' ? 'text-blue-600' : 'text-orange-600'}">${d.company}</div>
                        <div class="text-[10px] text-slate-400 font-bold mt-1 tracking-tight">${d.date} ${d.time}</div>
                    </td>
                    <td class="p-6">
                        <div class="font-bold text-slate-800">${d.client}</div>
                        <div class="text-[10px] text-slate-400 font-bold">聯絡：${d.contact || '-'}</div>
                    </td>
                    <td class="p-6">
                        <div class="text-xs font-bold text-slate-700">${d.vspec || '需求車次'}</div>
                        ${d.cargo.length > 0 ? `<div class="mt-2 bg-purple-100 text-purple-600 text-[9px] font-black px-2 py-0.5 rounded-full inline-block italic border border-purple-200">共 ${d.cargo.length} 項品項</div>` : ''}
                    </td>
                    <td class="p-6">
                        <div class="text-[10px] text-emerald-600 font-bold flex items-center mb-1"><i class="fas fa-caret-up mr-1.5 opacity-40"></i>${d.from || '-'}</div>
                        <div class="text-[10px] text-rose-500 font-bold flex items-center"><i class="fas fa-caret-down mr-1.5 opacity-40"></i>${d.to || '-'}</div>
                    </td>
                    <td class="p-6 text-right">
                        <div class="text-[10px] text-slate-400 font-bold mb-1">${d.vendor || '-'}</div>
                        <div class="text-slate-900 font-black text-sm">$${(Number(d.price) || 0).toLocaleString()}</div>
                    </td>
                    <td class="p-6 text-center">
                        <div class="flex justify-center space-x-3 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openModal('edit', '${d.id}')" class="w-9 h-9 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all shadow-sm"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="printDispatch('${d.id}')" class="w-9 h-9 rounded-xl bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white transition-all shadow-sm"><i class="fas fa-print text-xs"></i></button>
                            <button onclick="deleteDispatch('${d.id}')" class="w-9 h-9 rounded-xl bg-rose-50 text-rose-600 hover:bg-rose-600 hover:text-white transition-all shadow-sm"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            document.getElementById('stat-today').innerText = todayCount;
            document.getElementById('stat-month').innerText = monthCount;
        }

        // 彈窗邏輯
        function openModal(mode, id = null) {
            const form = document.getElementById('dispatchForm');
            form.reset();
            document.getElementById('cargoList').innerHTML = '';
            document.getElementById('editId').value = id || '';
            document.getElementById('modalTitle').innerText = id ? '編輯派車資料' : '新增派車申請';
            
            if (id) {
                const d = dispatches.find(x => x.id.toString() === id.toString());
                if(d) {
                    const companyRadio = document.querySelector(`input[name="company"][value="${d.company}"]`);
                    if(companyRadio) companyRadio.checked = true;
                    document.getElementById('f-date').value = d.date;
                    document.getElementById('f-time').value = d.time;
                    document.getElementById('f-applicant').value = d.applicant;
                    document.getElementById('f-client').value = d.client;
                    document.getElementById('f-contact').value = d.contact;
                    document.getElementById('f-phone').value = d.phone;
                    document.getElementById('f-address').value = d.address;
                    document.getElementById('f-vspec').value = d.vspec;
                    document.getElementById('f-from').value = d.from;
                    document.getElementById('f-to').value = d.to;
                    document.getElementById('f-vendor').value = d.vendor;
                    document.getElementById('f-price').value = d.price;
                    document.getElementById('f-notes').value = d.notes;
                    document.querySelectorAll('input[name="f-needs"]').forEach(cb => cb.checked = (d.needs || []).includes(cb.value));
                    (d.cargo || []).forEach(c => addCargoRow(c.n, c.q, c.u, c.l, c.w, c.h, c.wt));
                }
            } else {
                addCargoRow(); 
            }
            document.getElementById('formModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('formModal').style.display = 'none'; }

        function addCargoRow(n='', q='', u='件', l='', w='', h='', wt='') {
            const row = `<tr class="border-b border-slate-50 last:border-0">
                <td class="p-3"><input type="text" name="cn[]" value="${n}" placeholder="品項名稱"></td>
                <td class="p-3 w-20"><input type="number" name="cq[]" value="${q}" class="text-center"></td>
                <td class="p-3 w-20"><input type="text" name="cu[]" value="${u}" class="text-center"></td>
                <td class="p-3 w-20"><input type="text" name="cl[]" value="${l}" class="text-center"></td>
                <td class="p-3 w-20"><input type="text" name="cw[]" value="${w}" class="text-center"></td>
                <td class="p-3 w-20"><input type="text" name="ch[]" value="${h}" class="text-center"></td>
                <td class="p-3 w-24"><input type="text" name="cwt[]" value="${wt}" class="text-center"></td>
                <td class="p-3 text-center w-12"><button type="button" onclick="this.parentElement.parentElement.remove()" class="text-rose-400 hover:text-rose-600 transition-colors"><i class="fas fa-times-circle"></i></button></td>
            </tr>`;
            document.getElementById('cargoList').insertAdjacentHTML('beforeend', row);
        }

        document.getElementById('dispatchForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value || Date.now().toString();
            const cargo = [];
            const ns = document.getElementsByName('cn[]');
            const qs = document.getElementsByName('cq[]');
            const us = document.getElementsByName('cu[]');
            const ls = document.getElementsByName('cl[]');
            const ws = document.getElementsByName('cw[]');
            const hs = document.getElementsByName('ch[]');
            const wts = document.getElementsByName('cwt[]');

            for(let i = 0; i < ns.length; i++) {
                if(ns[i].value.trim()) {
                    cargo.push({ n: ns[i].value, q: qs[i].value, u: us[i].value, l: ls[i].value, w: ws[i].value, h: hs[i].value, wt: wts[i].value });
                }
            }

            const data = {
                id: id,
                company: document.querySelector('input[name="company"]:checked').value,
                date: document.getElementById('f-date').value,
                time: document.getElementById('f-time').value,
                applicant: document.getElementById('f-applicant').value,
                client: document.getElementById('f-client').value,
                contact: document.getElementById('f-contact').value,
                phone: document.getElementById('f-phone').value,
                address: document.getElementById('f-address').value,
                vspec: document.getElementById('f-vspec').value,
                needs: Array.from(document.querySelectorAll('input[name="f-needs"]:checked')).map(cb => cb.value),
                from: document.getElementById('f-from').value,
                to: document.getElementById('f-to').value,
                vendor: document.getElementById('f-vendor').value,
                price: document.getElementById('f-price').value,
                notes: document.getElementById('f-notes').value,
                cargo: cargo
            };

            await saveToCloud(data, "save");
        };

        async function deleteDispatch(id) {
            if(!confirm('確定要從雲端刪除這筆派車紀錄嗎？此操作不可還原。')) return;
            await saveToCloud({ id }, "delete");
        }

        function printDispatch(id) {
            const d = dispatches.find(x => x.id.toString() === id.toString());
            if(!d) return;

            document.getElementById('p-company-title').innerText = `${d.company} 派車單`;
            document.getElementById('p-datetime').innerText = `${d.date} ${d.time}`;
            document.getElementById('p-applicant').innerText = d.applicant;
            document.getElementById('p-client').innerText = d.client;
            document.getElementById('p-phone').innerText = d.phone;
            document.getElementById('p-address').innerText = d.address;
            document.getElementById('p-route').innerText = `${d.from || '-'} ⮕ ${d.to || '-'}`;
            document.getElementById('p-needs').innerText = d.needs.join(', ') || '無特殊輔助設備需求';
            document.getElementById('p-notes').innerText = d.notes || '無備註';

            const pList = document.getElementById('p-cargo-list');
            pList.innerHTML = d.cargo.map(c => `
                <tr>
                    <td class="border-[3px] border-slate-900 p-4 font-bold text-xl">${c.n}</td>
                    <td class="border-[3px] border-slate-900 p-4 text-center font-bold text-xl">${c.q} ${c.u}</td>
                    <td class="border-[3px] border-slate-900 p-4 text-center text-base font-bold">${c.l}x${c.w}x${c.h}m / ${c.wt}kg</td>
                </tr>`).join('');
            
            window.print();
        }

        function exportToExcel() {
            if (dispatches.length === 0) return alert('目前無資料可導出');
            
            const exportData = dispatches.map(d => ({
                '公司': d.company,
                '日期': d.date,
                '時間': d.time,
                '申請人': d.applicant,
                '客戶簡稱': d.client,
                '聯絡人': d.contact,
                '電話': d.phone,
                '下貨地址': d.address,
                '車輛規格': d.vspec,
                '特殊需求': d.needs.join(','),
                '行程起點': d.from,
                '行程終點': d.to,
                '配合廠商': d.vendor,
                '報價金額': Number(d.price) || 0,
                '備註事項': d.notes
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "派車明細");
            XLSX.writeFile(wb, `何鑫薪昌_派車統計_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        
        function searchTable() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('#dataTable tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        window.onclick = (e) => { if (e.target.id === 'formModal') closeModal(); };
    </script>
</body>
</html>
