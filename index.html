<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>何鑫/薪昌 - 雲端管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem; width: 100%; outline: none; transition: all 0.2s; background: white; font-size: 0.875rem; }
        input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .section-title { color: #1e40af; font-weight: 800; border-left: 5px solid #2563eb; padding-left: 0.75rem; margin-bottom: 1.25rem; font-size: 1rem; display: flex; align-items: center; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media print { .no-print { display: none !important; } #printArea { display: block !important; } body { background: white; padding: 0; } }
        #printArea { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="font-bold text-blue-800 tracking-widest">雲端資料同步中...</p>
    </div>

    <div class="max-w-7xl mx-auto no-print">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-xl border border-gray-100 gap-4">
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-4 rounded-2xl text-white shadow-lg shadow-blue-200">
                    <i class="fas fa-cloud text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight">何鑫實業 / 薪昌</h1>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Multi-User Management System</p>
                </div>
            </div>
            <div class="flex space-x-3 w-full md:w-auto">
                <button onclick="syncData()" class="flex-1 bg-white border border-slate-200 text-slate-600 px-5 py-3 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-2"></i> 同步
                </button>
                <button onclick="exportToExcel()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-xl font-bold shadow-md transition-all flex items-center justify-center">
                    <i class="fas fa-file-excel mr-2"></i> 導出月報表
                </button>
                <button onclick="openModal('add')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> 新增派車
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center transition-transform hover:scale-[1.01]">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase mb-1 tracking-widest">今日派車件數</p>
                    <h2 id="stat-today" class="text-5xl font-black text-slate-800 tracking-tighter">0</h2>
                </div>
                <div class="text-blue-500 bg-blue-50 p-5 rounded-2xl shadow-inner"><i class="far fa-calendar-check text-3xl"></i></div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center transition-transform hover:scale-[1.01]">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase mb-1 tracking-widest">本月累計派車</p>
                    <h2 id="stat-month" class="text-5xl font-black text-slate-800 tracking-tighter">0</h2>
                </div>
                <div class="text-indigo-500 bg-indigo-50 p-5 rounded-2xl shadow-inner"><i class="fas fa-layer-group text-3xl"></i></div>
            </div>
        </div>

        <div class="mb-6 relative">
            <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-300"></i>
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="快速搜尋客戶、下貨地點、廠商或申請人..." class="pl-14 py-5 rounded-3xl border-none shadow-lg text-slate-600 placeholder:text-slate-300 w-full">
        </div>

        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] border-b border-slate-100">
                        <tr>
                            <th class="p-6">公司 / 時間</th>
                            <th class="p-6">客戶資訊</th>
                            <th class="p-6">需求車輛</th>
                            <th class="p-6">行程路線</th>
                            <th class="p-6 text-right">廠商 / 報價</th>
                            <th class="p-6 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-slate-50">
                        <tr><td colspan="6" class="p-10 text-center text-slate-300">資料讀取中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="formModal" class="modal flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-[2.5rem] w-full max-w-6xl max-h-[94vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 id="modalTitle" class="text-2xl font-black text-slate-800">新增派車申請</h3>
                    <p class="text-xs text-slate-400 mt-1 font-bold">資料將同步儲存至雲端 Google Sheets</p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 flex items-center justify-center rounded-2xl hover:bg-white hover:shadow-md text-slate-400 transition-all font-bold text-xl">&times;</button>
            </div>
            
            <form id="dispatchForm" class="flex-1 overflow-y-auto p-8 md:p-12 space-y-12 custom-scrollbar">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                    <div>
                        <div class="section-title"><i class="fas fa-building mr-2"></i> 所屬公司</div>
                        <div class="flex gap-4 mt-2">
                            <label class="flex-1 flex items-center justify-center p-4 rounded-2xl border-2 cursor-pointer transition-all has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 has-[:checked]:text-blue-700">
                                <input type="radio" name="company" value="何鑫實業" checked class="hidden">
                                <span class="font-bold">何鑫實業</span>
                            </label>
                            <label class="flex-1 flex items-center justify-center p-4 rounded-2xl border-2 cursor-pointer transition-all has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 has-[:checked]:text-orange-700">
                                <input type="radio" name="company" value="薪昌" class="hidden">
                                <span class="font-bold">薪昌</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <div class="section-title"><i class="far fa-clock mr-2"></i> 派車時間</div>
                        <div class="flex gap-2">
                            <input type="date" id="f-date" required>
                            <input type="time" id="f-time" required>
                        </div>
                    </div>
                    <div>
                        <div class="section-title"><i class="far fa-user mr-2"></i> 申請人</div>
                        <input type="text" id="f-applicant" placeholder="請輸入姓名" required>
                    </div>
                </div>

                <div>
                    <div class="section-title"><i class="fas fa-id-card-alt mr-2"></i> 專案資訊 (客戶聯動)</div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="relative">
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">客戶簡稱 *</label>
                            <input type="text" id="f-client" list="clientOptions" placeholder="搜尋或手動輸入..." oninput="handleClientLookup(this.value)">
                            <datalist id="clientOptions"></datalist>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">現場聯絡人</label>
                            <input type="text" id="f-contact">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">聯絡電話</label>
                            <input type="tel" id="f-phone">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest">預定下貨地址</label>
                            <input type="text" id="f-address">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div>
                        <div class="section-title"><i class="fas fa-truck mr-2"></i> 車輛規格</div>
                        <input type="text" id="f-vspec" list="vOptions" placeholder="選擇或手動輸入車型規格...">
                        <datalist id="vOptions"></datalist>
                    </div>
                    <div>
                        <div class="section-title"><i class="fas fa-plus-circle mr-2"></i> 特殊需求 (複選)</div>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="需車尾門" class="mr-3 w-4 h-4 rounded"> 需車尾門
                            </label>
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="需油壓板車" class="mr-3 w-4 h-4 rounded"> 需油壓板車
                            </label>
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="兩地載貨" class="mr-3 w-4 h-4 rounded"> 兩地載貨
                            </label>
                            <label class="flex items-center p-3 border rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-bold text-slate-600 transition-colors">
                                <input type="checkbox" name="f-needs" value="需堆高機" class="mr-3 w-4 h-4 rounded"> 需堆高機
                            </label>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="section-title"><i class="fas fa-boxes mr-2"></i> 出貨清單明細</div>
                    <div class="overflow-x-auto border rounded-2xl shadow-inner bg-slate-50/20">
                        <table class="w-full text-xs">
                            <thead class="bg-slate-100 text-slate-500 font-black border-b">
                                <tr>
                                    <th class="p-4 text-left">品項名稱</th>
                                    <th class="p-4 text-center w-20">數量</th>
                                    <th class="p-4 text-center w-20">單位</th>
                                    <th class="p-4 text-center w-20">長(m)</th>
                                    <th class="p-4 text-center w-20">寬(m)</th>
                                    <th class="p-4 text-center w-20">高(m)</th>
                                    <th class="p-4 text-center w-24">重量(kg)</th>
                                    <th class="p-4 text-center w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="cargoList"></tbody>
                        </table>
                    </div>
                    <button type="button" onclick="addCargoRow()" class="mt-4 text-blue-600 font-black text-xs flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-lg"></i> 新增品項行
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 border-t pt-10">
                    <div class="space-y-4">
                        <div class="section-title"><i class="fas fa-map-marked-alt mr-2"></i> 行程與備註</div>
                        <div class="flex gap-2">
                            <input type="text" id="f-from" placeholder="上貨地點 (起點)">
                            <input type="text" id="f-to" placeholder="下貨地點 (目的地)">
                        </div>
                        <textarea id="f-notes" rows="3" placeholder="備註事項"></textarea>
                    </div>
                    <div class="space-y-4">
                        <div class="section-title"><i class="fas fa-hand-holding-usd mr-2"></i> 廠商報價</div>
                        <input type="text" id="f-vendor" list="vendorOptions" placeholder="選擇廠商">
                        <datalist id="vendorOptions"></datalist>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-300">NT$</span>
                            <input type="number" id="f-price" placeholder="0" class="pl-14">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 border-t pt-10 bg-white sticky bottom-0 z-10">
                    <button type="button" onclick="closeModal()" class="px-10 py-4 text-slate-400 font-bold">取消</button>
                    <button type="submit" class="px-16 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> 儲存並同步雲端
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="printArea" class="p-16 text-slate-900 bg-white">
        <h1 id="p-company-title" class="text-4xl font-black text-center border-b-[6px] border-slate-900 pb-6 mb-12"></h1>
        <div class="grid grid-cols-2 gap-y-6 mb-12 text-lg">
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">派車時間：</span> <span id="p-datetime" class="font-bold"></span></div>
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">申請人員：</span> <span id="p-applicant" class="font-bold"></span></div>
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">客戶簡稱：</span> <span id="p-client" class="font-bold"></span></div>
            <div class="border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">聯絡電話：</span> <span id="p-phone" class="font-bold"></span></div>
            <div class="col-span-2 border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">下貨地址：</span> <span id="p-address" class="font-bold text-xl"></span></div>
            <div class="col-span-2 border-b border-slate-200 pb-3 flex"><span class="font-bold w-40 text-slate-400 italic">行程路線：</span> <span id="p-route" class="font-bold"></span></div>
        </div>
        <table class="w-full border-collapse border-[3px] border-slate-900 mb-12 text-lg">
            <thead><tr class="bg-slate-50"><th class="border-[3px] border-slate-900 p-4">品項名稱</th><th class="border-[3px] border-slate-900 p-4">數量單位</th><th class="border-[3px] border-slate-900 p-4">規格尺寸</th></tr></thead>
            <tbody id="p-cargo-list"></tbody>
        </table>
        <div class="space-y-4 mb-24">
            <div class="flex"><span class="font-black w-32 border-l-4 border-slate-900 pl-3">特殊需求：</span><span id="p-needs" class="font-bold text-blue-700 underline"></span></div>
            <div class="flex"><span class="font-black w-32 border-l-4 border-slate-900 pl-3">備註事項：</span><span id="p-notes" class="font-medium text-slate-500"></span></div>
        </div>
        <div class="grid grid-cols-3 gap-16 text-center">
            <div><div class="border-b-2 border-slate-900 h-24"></div><p class="mt-4 font-black">核准主管</p></div>
            <div><div class="border-b-2 border-slate-900 h-24"></div><p class="mt-4 font-black">收貨簽章</p></div>
            <div><div class="border-b-2 border-slate-900 h-24"></div><p class="mt-4 font-black">駕駛簽章</p></div>
        </div>
    </div>

    <script>
        // 1. 請填入你的 GAS 網址
        const GAS_URL = "在此處貼上你的網址";

        let masterData = { clients: [], vendors: [], vehicles: [] };
        let dispatches = [];

        document.addEventListener('DOMContentLoaded', () => { if(GAS_URL.length > 10) syncData(); });

        async function syncData() {
            toggleLoading(true);
            try {
                const res = await fetch(GAS_URL).then(r => r.json());
                masterData.clients = res.clients || [];
                // 這裡配合你的試算表標題：廠商名稱、車輛規格
                masterData.vendors = (res.vendors || []).map(v => v.廠商名稱).filter(v => v);
                masterData.vehicles = (res.vehicles || []).map(v => v.車輛規格).filter(v => v);
                
                dispatches = (res.records || []).map(r => ({
                    ...r,
                    needs: r.needs ? JSON.parse(r.needs) : [],
                    cargo: r.cargo ? JSON.parse(r.cargo) : []
                })).sort((a,b) => b.id - a.id);

                updateDatalists();
                renderTable();
            } catch (err) { alert("同步失敗，請確認 GAS 網址與權限。"); }
            finally { toggleLoading(false); }
        }

        async function saveToCloud(data, action = "save") {
            toggleLoading(true);
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action, data }) });
                setTimeout(() => { syncData(); closeModal(); }, 1000);
            } catch (err) { alert("儲4存失敗"); toggleLoading(false); }
        }

        function updateDatalists() {
            document.getElementById('clientOptions').innerHTML = masterData.clients.map(c => `<option value="${c.客戶簡稱}">`).join('');
            document.getElementById('vOptions').innerHTML = masterData.vehicles.map(v => `<option value="${v}">`).join('');
            document.getElementById('vendorOptions').innerHTML = masterData.vendors.map(v => `<option value="${v}">`).join('');
        }

        function handleClientLookup(val) {
            const c = masterData.clients.find(x => x.客戶簡稱 === val);
            if (c) {
                document.getElementById('f-contact').value = c.聯絡人 || '';
                document.getElementById('f-phone').value = c.電話 || '';
                document.getElementById('f-address').value = c.下貨地址 || '';
                document.getElementById('f-to').value = c.下貨地址 || '';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            let tCount = 0, mCount = 0;
            const today = new Date().toISOString().split('T')[0];
            const curM = new Date().getMonth();

            dispatches.forEach(d => {
                if(d.date === today) tCount++;
                if(new Date(d.date).getMonth() === curM) mCount++;

                tbody.insertAdjacentHTML('beforeend', `
                <tr class="hover:bg-slate-50 group">
                    <td class="p-6">
                        <div class="font-black text-xs ${d.company === '何鑫實業' ? 'text-blue-600' : 'text-orange-600'}">${d.company}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${d.date} ${d.time}</div>
                    </td>
                    <td class="p-6"><div class="font-bold">${d.client}</div></td>
                    <td class="p-6"><div class="text-xs">${d.vspec || '-'}</div></td>
                    <td class="p-6"><div class="text-[10px] text-emerald-600">${d.from || '-'} ⮕ ${d.to || '-'}</div></td>
                    <td class="p-6 text-right"><div class="font-black">$${(Number(d.price) || 0).toLocaleString()}</div></td>
                    <td class="p-6 text-center">
                        <button onclick="openModal('edit', '${d.id}')" class="w-8 h-8 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-pen text-xs"></i></button>
                        <button onclick="printDispatch('${d.id}')" class="w-8 h-8 bg-emerald-50 text-emerald-600 rounded-lg mx-1"><i class="fas fa-print text-xs"></i></button>
                        <button onclick="deleteDispatch('${d.id}')" class="w-8 h-8 bg-rose-50 text-rose-600 rounded-lg"><i class="fas fa-trash text-xs"></i></button>
                    </td>
                </tr>`);
            });
            document.getElementById('stat-today').innerText = tCount;
            document.getElementById('stat-month').innerText = mCount;
        }

        function openModal(mode, id = null) {
            document.getElementById('dispatchForm').reset();
            document.getElementById('cargoList').innerHTML = '';
            document.getElementById('editId').value = id || '';
            if (id) {
                const d = dispatches.find(x => x.id.toString() === id.toString());
                if(d) {
                    document.querySelector(`input[name="company"][value="${d.company}"]`).checked = true;
                    ['date','time','applicant','client','contact','phone','address','vspec','from','to','vendor','price','notes'].forEach(k => {
                        const el = document.getElementById('f-'+k); if(el) el.value = d[k];
                    });
                    document.querySelectorAll('input[name="f-needs"]').forEach(cb => cb.checked = d.needs.includes(cb.value));
                    d.cargo.forEach(c => addCargoRow(c.n, c.q, c.u, c.l, c.w, c.h, c.wt));
                }
            } else { addCargoRow(); }
            document.getElementById('formModal').style.display = 'flex';
        }

        function addCargoRow(n='', q='', u='件', l='', w='', h='', wt='') {
            document.getElementById('cargoList').insertAdjacentHTML('beforeend', `
            <tr class="border-b">
                <td class="p-2"><input type="text" name="cn[]" value="${n}"></td>
                <td class="p-2 w-20"><input type="number" name="cq[]" value="${q}"></td>
                <td class="p-2 w-20"><input type="text" name="cu[]" value="${u}"></td>
                <td class="p-2 w-20"><input type="text" name="cl[]" value="${l}"></td>
                <td class="p-2 w-20"><input type="text" name="cw[]" value="${w}"></td>
                <td class="p-2 w-20"><input type="text" name="ch[]" value="${h}"></td>
                <td class="p-2 w-24"><input type="text" name="cwt[]" value="${wt}"></td>
                <td class="p-2 text-center"><button type="button" onclick="this.parentElement.parentElement.remove()">&times;</button></td>
            </tr>`);
        }

        document.getElementById('dispatchForm').onsubmit = async (e) => {
            e.preventDefault();
            const cargo = [];
            const ns = document.getElementsByName('cn[]');
            for(let i=0; i<ns.length; i++) {
                if(ns[i].value) cargo.push({
                    n: ns[i].value, q: document.getElementsByName('cq[]')[i].value, u: document.getElementsByName('cu[]')[i].value,
                    l: document.getElementsByName('cl[]')[i].value, w: document.getElementsByName('cw[]')[i].value,
                    h: document.getElementsByName('ch[]')[i].value, wt: document.getElementsByName('cwt[]')[i].value
                });
            }
            const data = {
                id: document.getElementById('editId').value || Date.now().toString(),
                company: document.querySelector('input[name="company"]:checked').value,
                date: document.getElementById('f-date').value,
                time: document.getElementById('f-time').value,
                applicant: document.getElementById('f-applicant').value,
                client: document.getElementById('f-client').value,
                contact: document.getElementById('f-contact').value,
                phone: document.getElementById('f-phone').value,
                address: document.getElementById('f-address').value,
                vspec: document.getElementById('f-vspec').value,
                needs: Array.from(document.querySelectorAll('input[name="f-needs"]:checked')).map(cb => cb.value),
                from: document.getElementById('f-from').value,
                to: document.getElementById('f-to').value,
                vendor: document.getElementById('f-vendor').value,
                price: document.getElementById('f-price').value,
                notes: document.getElementById('f-notes').value,
                cargo: cargo
            };
            await saveToCloud(data, "save");
        };

        async function deleteDispatch(id) { if(confirm('刪除？')) await saveToCloud({id}, "delete"); }
        function closeModal() { document.getElementById('formModal').style.display = 'none'; }
        function toggleLoading(s) { document.getElementById('loading').style.display = s?'flex':'none'; }
        
        function printDispatch(id) {
            const d = dispatches.find(x => x.id.toString() === id.toString());
            if(!d) return;
            document.getElementById('p-company-title').innerText = d.company + " 派車單";
            document.getElementById('p-datetime').innerText = d.date + " " + d.time;
            document.getElementById('p-applicant').innerText = d.applicant;
            document.getElementById('p-client').innerText = d.client;
            document.getElementById('p-phone').innerText = d.phone;
            document.getElementById('p-address').innerText = d.address;
            document.getElementById('p-route').innerText = d.from + " ⮕ " + d.to;
            document.getElementById('p-needs').innerText = d.needs.join(', ') || '無';
            document.getElementById('p-notes').innerText = d.notes || '無';
            document.getElementById('p-cargo-list').innerHTML = d.cargo.map(c => `
                <tr><td class="border p-2">${c.n}</td><td class="border p-2 text-center">${c.q}${c.u}</td><td class="border p-2 text-center">${c.l}x${c.w}x${c.h}m / ${c.wt}kg</td></tr>
            `).join('');
            window.print();
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(dispatches.map(d => ({
                公司: d.company, 日期: d.date, 客戶: d.client, 廠商: d.vendor, 金額: d.price
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "紀錄");
            XLSX.writeFile(wb, "派車紀錄.xlsx");
        }

        window.onclick = (e) => { if (e.target.id === 'formModal') closeModal(); };
    </script>
</body>
</html>
